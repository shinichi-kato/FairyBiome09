# FairyBiome　マスタリングノート

## チャットボットのmentalLevelとmoment
会話は始まったばかりのとき場の温度は低く、会話が噛み合って続くと場は温まってくる、と形容される。場の温度によって会話の内容としてふさわしい内容も変化し、温度が低い間は挨拶、天候、相手の様子を伺うなどのトピックが多く、会話が温まってきたら専門的な情報交換や個人的な事項の開示が好まれる。この挙動を表現するのがmentalLevelとmomentである。

### mentalLevel

mentalLevelの初期値はchatbot.jsonで定義され、以下のイベントにより変化する。値は会話終了後も保持される。mentalLevelの値は100を超えない。

mentalLevel変化イベント                    | 変化量       
-------------------------------------------|-------------
会話の中でチャットボットが新しく言葉を学習 | +2
momentが10になった                         | +1
ユーザからネガティブな反応を返された       | -5
ユーザからポジティブな反応を返された       | 一日最大+1


### moment

momentは会話開始時に0で、以下のイベントにより変化する。値は会話終了後保持されない。またmemontの値はmentalLevelを超えない。

moment変化イベント                         | 変化量       
-------------------------------------------|-------------
ユーザから返答をもらった                   | +1
ユーザからネガティブな反応を返された       | -1


各パートにはパラメータ momentUpper、momentLower があり、現在のmomentがおおよそその範囲に入っていた場合パートが返答の生成を試みる。


## 会話の開始と終了

最も単純にはアプリの起動、終了を会話の開始と終了とみなす方法が考えられるが、webアプリの場合は終了が明確でなく、一旦終了してもう一度起動したときに「こんにちは！」と言われると違和感がある。そのため1:1会話であるdialogモードではユーザが最後に返答を行った時刻 userLastAccess としてworkに記憶しておき、それが config.keep_alive で設定した期間を超えたら会話が終わっているとみなす。
多対多会話であるpolylogueの場合は入室/退室を会話の開始/終了とみなす。


## 睡眠と覚醒

## パートの遷移
チャットボットのパートは挨拶、趣味の話、天気の話、はしゃぐ気持ち、落ち込む気持ち、相談にのる、などの「心のパート」ごとに用意し、パート名と同名のアバターが画面に表示される。

### ユーザ入力に反応した自動パート遷移
複数のパートが競争的に動作している中で、入力に対して最も一致度の高い返答が可能なパートは発言を生成するとともにhoistされ、次のexecute時にそのパートから優先的に評価される。

### Message経由triggerによる明示的パート遷移
executeでトリガーmessageを渡すことで明示的にパート遷移を起こすことができる。ecosystemの変化はこの方法で通知され、{enter_気候名}というトリガーを送るとそれに一致したINをもつパートがhoistされる可能性が高くなる。

{enter_パート名}というトリガの場合にはそのパートがhoistされ、そのパートの{on_enter_part}が発言される。


### 発言に含まれるタグによるパート遷移



## チャットボットの生成と所有
チャットボットをゼロから作成するのは大変なので、最初にチャットボットを生成時するときはテンプレート用に用意したチャットボットから一つを選ぶ。またユーザが過去に保存したチャットボットを呼び出して使うこともできる。
それら以外にユーザが所有できないNPCチャットボットがあり、システムがそれを利用する。

## はじまり
ユーザは新規にチャットボットを作成するか、過去にサーバーに保存したチャットボットを呼び出してFairyBiomeを開始することができる。新しくチャットボットを作成した場合は名前と背景色を設定する。

## 森
ユーザが森に入ると、連れているチャットボットの情報が一日最大一回、自動的にサーバーに保存される。ユーザが森に入ったとき、設定した確率で以下のイベントが発生する

・チューター妖精が現れて会話が始まる
　チューター妖精は妖精との付き合い方や育て方について質問に答えてくれる
・誰かの作成したチャットボットが現れて会話が始まる
　サーバーに保存されたチャットボットのうちどれかが一時的にロードされ、会話ができる。
　ユーザ自身が作成したものも含む。
・誰も現れない
　

なお、森ではチャットボットは会話が終わるとユーザをおいてどこかに去る。
ユーザ自身が所有するチャットボットは会話により学習するが、他のチャットボットは
永続化していないため、ユーザが森を出た時点でリセットされる。

## 公園
ユーザは公園に来ている誰か、およびその誰かの連れているチャットボットと会話ができる。
各ユーザはチャットボットを所有している状態のため、公園での会話をチャットボットは
学習する。学習結果はユーザが森に入ることでサーバーに記憶される。

## 部屋
ユーザは自分の連れているチャットボットとのみ会話ができる。

## part スクリプト

key           | 内容
--------------|-------------------------------------------------
{on_enter_part}  | パートに切り替わったときに自動的に使用される